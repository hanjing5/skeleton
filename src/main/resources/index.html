<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="style.css" />
    <script data-require="jquery@*" data-semver="3.1.1" src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <style>
        #container {border: 1px solid brown;}
        H1 {float: left;}

        .button{
            background-color:#55A;
            border: 1px solid #229;
            width: 100px;
            float: right;
            font-size: 2em;
            color: white;
            text-align: center;
        }

        #receiptList {
            border: 1px solid green;
            clear: both;
        }

        .receipt {
            background-color: #eee;
            margin-bottom: 5px;
        }

    </style>
    <script>
        // This is the idiomatic way to ensure that JQuery does not
        // execute until the page has loaded
        function genTagPill(tag_name) {
            return '<div class="tagValue">' + tag_name + '</div>'
        }

        function genTagCells(tag) {
            $('#tag-holder-for-receipt-id-' + tag.id).append(genTagPill(tag.tag));
        }

        function addTagElement(receiptObj, tag_name) {
            console.log('addTagElmenet');
            console.log(receiptObj.children('div.tags'));
            console.log('tag_name ' + tag_name);
            receiptObj.append(genTagPill (tag_name));
        }

        function removeTag(that) {
            // var tagInput = '<div><input class="tag_input" /><div class="button">Enter</div></div>'
            // $(that).after(`${tagInput}`);
            
            var tag_name = $(that).prev().val();
            console.log('tag_name '+ tag_name);
            var receiptObj = $(that).parent().parent();
            var merchant_id = receiptObj.children('div.receipt-id').text();

            console.log('receipt-id ' + merchant_id);

            // $(that).click(function( event ) {
            console.log('triggered');

            $.ajax({
              type: "PUT",
              url: "/tags/" + tag_name,
              data: merchant_id,
              contentType: "application/json; charset=utf-8", 
              success: function() {
                console.log('success!');
                // console.log(cellContent)
                // $('#receiptList').append(cellContent);
                addTagElement(receiptObj, tag_name);
              },
              error: function(model, xhr, options){

                console.log('response is : ');
                console.log(xhr.responseText);
              }
            });
            

            $(that).parent().remove();
        }

        function foo(that) {
            var tagInput = '<div><input class="tag_input" /><div class="button" onclick=removeTag(this)>Enter</div></div>'
            $(that).after(`${tagInput}`);
        }

        function genReceiptCell(id, merchant, amount, created) {
            return `<div class="receipt" id="receipt-id-" + ${id}>
                        <div class="receipt-id">${id}</div>
                        <div class="merchant">${merchant}</div>
                        <div class="amount">${amount}</div>
                        <div class="created">${created}</div>
                        <div class="tags" id="tag-holder-for-receipt-id-${id}"></div>
                        <span class="receiptTag">t1-placeholder</span>
                        <div class='button add-tag' onclick="foo(this)">Add +</div>
                        <div class='input-holder'></div>
                    </div>`
        }

        $(function(){
            const api = ""; // <- do not need a root api URL if this page is served directly by the API

            $.getJSON(api+"/receipts", function(receipts){
                for(var i=0; i < receipts.length; i++) {
                    var receipt = receipts[i];
                    console.log(receipt);
                    var cellContent = genReceiptCell(receipt.id, receipt.merchantName, receipt.value, receipt.created);
                    $(cellContent)
                        .appendTo($("#receiptList"));
                }
                $.ajax({
                  url: '/tags',
                  // data: data,
                  success: function (tags){

                    for(var i=0; i < tags.length; i++) {
                        var tag = tags[i];
                        console.log(tag);
                        genTagCells(tag);
                    }
                  },
                  // dataType: dataType
                });
            })

            $( "#add-receipt" ).click(function() {
                $("#add-receipt-form").toggle();
                $('#merchant').val('');;
                $('#amount').val('');;
            });    
        })
    </script>
</head>

<body>
<DIV id="container">
    <h1>My receipts</h1>
    <div class="button" id="add-receipt">+</div>
    <form action='' style="display:none" id='add-receipt-form'>
        <input type='text' name='merchant' id='merchant' placeholder='merchant'><br>
        <input type='text' name='amount' id='amount' placeholder='amount'><br>
        <div class='button' id='cancel-receipt'>cancel</div>
        <div class='button' id='save-receipt'>save</div>
    </form>
    <div id="receiptList">
    </div>
</DIV>
<script>
    $( "#save-receipt" ).click(function( event ) {
        // alert('asdfasd');
        $.ajax({
          type: "POST",
          url: "/receipts",
          data: '{"merchant": "'+$('#merchant').val()+'","amount":'+$('#amount').val()+'}',
          contentType: "application/json; charset=utf-8", 
          success: function() {
            var cellContent = genReceiptCell($('#receipt-id').val(), $('#merchant').val(), $('#amount').val(), $('#created').val());
            console.log(cellContent)
            $('#receiptList').append(cellContent);
          }
        });
        event.preventDefault();
    });
</script>
</body>

</html>
